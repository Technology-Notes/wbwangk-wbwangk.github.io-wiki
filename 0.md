## 领币逻辑（v0.3） 2018-6-20  
领币逻辑现在依赖“任务系统”。将用户注册、实名认证、签到、关注公众号、好友推荐等都视为任务（quest）。将拼图游戏、市场调查等众包活动也视为任务。发币周期为24小时，零点启动发币程序，发币程序根据任务信息计算向各个消费者账户的发币金额。

### Power（质能、元素、算力）
Power分为长期Power和临时Power，临时Power当天有效。 任务的奖励可能是长期Power，也可能是临时Power，甚至是两者的组合。只要在有效期内，无论长期Power还是临时Power，在发币逻辑中的作用是一样的。在零点的发币逻辑中，在临时Power使用后，会将用户的临时Power清空。  

引入Power机制后，质量链网官方ETH的发行变得更有计划性。避免了单个任务奖金设置偏高或偏低的问题。

### 任务
任务分为日常任务和普通任务（即一次性任务）。  
- 日常任务的任务记录在零点清除，使用户可以每天完成一次该任务  
- 普通任务的任务记录不会清除，每个任务用户只能完成一次  

为了提高性能，结束的任务（包括昨天及以前的日常任务）记录转移到“历史任务”表中。  

#### 任务生命周期
任务可能设定生效时间，只有当生效时间达到后才会由管理程序将任务状态修改为“生效”状态。“停止”或“取消”状态的任务是不能进入的。  

任务的结束有几种可能：
- 达到“到期时间”  
- 完成任务的人数达到设定的上限  
- 任务的奖金用完  
 
第一种情况需要定时器检查到期时间，并将到期任务的状态修改为“结算”状态。如果有的任务不需要结算，则直接修改为“发币”状态（哪种任务不需要结算下面讲）。  

后两种情况直接在用户做任务的逻辑中实现，即当检测到人数达到上限或任务奖金用完，直接将任务状态修改为“结算”或“发币”状态（根据任务类型，下面讲）

#### 任务状态
新建--> 生效 --> 结算 --> 发币 --> 结束

“暂停”状态是一种中间状态，可以从任意状态进入暂停状态，也可以从暂停状态手工修改为任意状态。  
“取消”状态表达一种非正常结束的状态。 
部分任务可以直接从“生效”状态跳过“结算”，转到“发币”状态。  

结算程序负责将“结算”改成“发币”，发币程序负责将“发币”改成“结束”。

#### 动态奖金
任务可以设定一个总的奖金金额，无论多少个用户完成了该任务，都可以分享这个总奖金。这样对于完成任务的具体用户，得到奖金是动态的，即总奖金除以参加用户数。

设置了总奖金的任务分给每个用户的奖金与参加任务的人数有关。为了防止参加结算类型任务的用户数很少时，少数用户获得的奖金过高的问题，设置了一个“最少人数”的字段。如果完成任务的用户数少于“最少人数”，则按“最少人数”分割奖金。  

#### 固定奖金
除了为任务设置一个总奖金外，还可以为任务设置一个“固定奖金”的参数。表示每个完成该任务的用户，除了获得结算的奖金外，额外会获得这个固定数量的奖金。

#### 任务与Power
任务可以设置“长期Power”和“临时Power”两个数量型参数，表示完成该任务的用户可以获得的Power数。零点执行的发币逻辑中，会使用和处理这两个Power字段，只有“发币”状态任务的会被发币逻辑处理。


#### 任务来源
当前的任务来源分为官方、企业，未来可能会增加消费者来源（审批？）。  

官方任务的奖励Power、ETH，或两者的组合。奖励的Power可能是长期Power、临时Power，或两者的组合。这样最复杂的任务奖励可能会同时奖励长期Power、临时Power和ETH。而奖励的ETH又分为固定奖励和动态奖励。动态奖励指为任务设定一个总奖金，参加任务的用户分享总奖金。

企业任务只能奖励ETH。

### 发币
从“发币”这个自建称谓来自对ETH（五彩石）的发行。每24小时进行一次发币计算。暂定零点进行发币计算，但延迟到凌晨三四点钟计算更合理。

这个批量计算实际上由三部分构成：
- 任务结算
- 发币
- 数据转储
 
任务结算有两个输出：Power和ETH
- 为参加任务的用户结算Power，包括长期Power和临时Power。将长期Power和临时Power分别累加到参加任务的每个用户身上
- 为参加任务的用户结算ETH。根据每个任务的奖金总量，按设定的算法（当前是均分）将总奖金分解到每个用户身上
 
任务结算出来的Power是发币程序的输入。发币的本质是用户以Power做权重分享当天的官方ETH发行总量。

发币的完整过程可分为两个部分：
- 在关系数据库（未来可能升级为key-value数据库）中计算每个用户昨天可以获得的ETH，主要是根据Power分配当天发行的ETH到每个用户
- 用户将ETH从关系库提取到以太坊钱包

数据转储指将数据从“任务回答”转移到“任务回答历史”表中，或其他的历史数据处理。

### 领币
将领币逻辑变成用户将ETH从应用（关系库）提取到区块链钱包。额外好处：由于用户领币操作的在时间上是散布的，在区块浏览器上可以看到比较漂亮的交易记录。

### 拼图任务
每个拼图任务都有一个固定任务id，以及一些对应的备选拼图图片。拼图任务一般是日常任务，但每天的拼图可能不一样。零点重置任务后可能需要随机挑选对应的图片。完成设定数量的拼图后任务才能完成。

拼图任务可以直接使用任务表的EXT_DATA字段保存任务的特定数据，或自己加表。

### 数据结构
#### 任务(QUEST)
名称 | 类型 | 非空 | 主键 | 备注
-- | -- | -- | -- | --
QUEST_ID | integer | √ | √ | 任务id，自动增长
QUEST_TYPE | char(1) |  √ |  | 任务类型，D(daily)：日常任务，O(once)：一次性任务
STATUS | char(1) |   √|  | 状态，1：新建，2：生效，3：结算，4：发币，5：结束，8：暂停，9：取消
CREATE_TIME | datetime |  |  | 创建时间
START_TIME | datetime |  |  | 开始时间
END_TIME | datetime |  |  | 结束时间
MAX_TIMES | integer |  |  | 完成任务的最多人数，参加该任务人数达到设定值时自动结束
MIN_TIMES | integer |  |  | 完成任务的最少人数，如果参加该任务的人数不到最少人数，任务结算时仍按最少人数计算
BOUNTY | decimal(16,4)|  |  | 总奖金总数
SUBSIDY | decimal(12,8)|  |  | 固定奖金
LONG_POWER | integer |  |  | 长期质能
TEMP_POWER | integer |  |  | 临时质能
USER_ID | varchar(16) | √  |  | 用户id，任务的拥有者，控制权限
TITLE | varchar(128) | √  |  | 标题
TITLE_IMAGE| varchar(128) |  |  | 标题图片url
BODY | varchar(2048) |  |  | 内容
QUEST_COUNT | integer |  |  | 任务计数，已经完成任务的次数
EXT_DATA|  varchar(64) |  |  | 扩展数据

#### 任务回答(QUEST_ANSWER)
名称 | 类型 | 非空 | 主键 | 备注
-- | -- | -- | -- | --
ANSWER_ID | integer | √ | √ | 任务回答id，自动增长
QUEST_ID | integer |  |  | 任务id，表示这是哪个任务的回答
USER_ID | varchar(16) |  |  | 用户id，记录哪个用户完成任务
BODY | varchar(2048) |  |  | 内容
CREATE_TIME | datetime |  |  | 创建时间
STATUS | char(1) | √ |  | 状态，1：新建，5：完成
REWARD | decimal(12,8)|  |  | 奖金
LONG_POWER | integer |  |  | 长期质能
TEMP_POWER | integer |  |  | 临时质能

#### 任务回答历史(QUEST_ANSWER_HIS)
名称 | 类型 | 非空 | 主键 | 备注
-- | -- | -- | -- | --
ANSWER_ID | integer | √ | √ | 任务回答id，自动增长
QUEST_ID | integer |  |  | 任务id，表示这是哪个任务的回答
USER_ID | varchar(16) |  |  | 用户id，记录哪个用户完成任务
BODY | varchar(2048) |  |  | 内容
CREATE_TIME | datetime |  |  | 创建时间
STATUS | char(1) | √ |  | 状态，1：新建，2：生效，3：结算，4：发币，5：结束，8：暂停，9：取消
REWARD | decimal(12,8)|  |  | 奖金
LONG_POWER | integer |  |  | 长期质能
TEMP_POWER | integer |  |  | 临时质能

#### 用户数据(USER_DATA)
名称 | 类型 | 非空 | 主键 | 备注
-- | -- | -- | -- | --
USER_ID | varchar(16) | √ | √ | 用户id
BALANCE | decimal(18,8)|  |  | 余额
REWARD | decimal(12,8)|  |  | 奖金，领币后清零
LONG_POWER | integer |  |  | 长期质能
TEMP_POWER | integer |  |  | 临时质能，发币后清零